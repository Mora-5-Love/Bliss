// ntt32.c
// 09-Jun-15  Markku-Juhani O. Saarinen <m.saarinen@qub.ac.uk>

// Number-Theoretic Transforms on a max 31-bit q value

#include <assert.h>
#include <stdbool.h>
#include <stdlib.h>
#include "ntt_blzzd.h"

// Basic arithmetic primitives
// Written as separate functions -- so that they can be instrumented easily.

static int32_t ntt32_muln(int32_t x, int32_t y, int32_t n)
{
    return (((int64_t) x) * ((int64_t) y)) % ((int64_t) n);
}

static int32_t ntt32_sqrn(int32_t x, int32_t n)
{
    return (((int64_t) x) * ((int64_t) x)) % ((int64_t) n);
}

// Compute x^e (mod n).

int32_t ntt32_pwr(int32_t x, int32_t e, int32_t n)
{
    int32_t y;

    y = 1;
    if (e & 1)
        y = x;

    e >>= 1;

    while (e > 0) {
        x = ntt32_sqrn(x, n);
        if (e & 1)
            y = ntt32_muln(x, y, n);
        e >>= 1;
    }

    return y;
}


/*
 * FFT operation (forward and inverse).  
 *
 * BD: modified to use 32-bit arithmetic (don't use ntt32_muln), 
 * which is safe if q is less than 2^16.
 * Also forced intermediate results to be between 0 and q-1.
 */
static inline int32_t sub_mod(int32_t x, int32_t y, int32_t q) {
  x -= y;
  return x < 0 ? x + q : x;
}

static inline int32_t add_mod(int32_t x, int32_t y, int32_t q) {
  x += y;
  return x - q >= 0 ? x - q : x;
}


static bool check_arg(int32_t v[], uint32_t n, int32_t q){
  uint32_t i;

  for(i = 0; i < n; i++){
    if(v[i] < 0){ return false; }
    if(v[i] >= q){ return false; }
  }

  return true;
}

void ntt32_fft(int32_t v[], uint32_t n, int32_t q, const int32_t w[]) {
  uint32_t i, j, k, l;
  int32_t x, y;

  assert(check_arg(v, n, q));

  // bit-inverse shuffle
  j = n >> 1;
  for (i = 1; i < n - 1; i++) {       // 00..0 and 11..1 remain same
    if (i < j) {
      x = v[i];
      v[i] = v[j];
      v[j] = x;
    }
    k = n;
    do {
      k >>= 1;
      j ^= k;
    } while ((j & k) == 0);
  }

  // main loops
  l = n;         // BD: avoid division n/i in the loop
  for (i = 1; i < n; i <<= 1) {
    //    l = n / i;
    for (k = 0; k < n; k += i + i) {
      x = v[k + i];
      v[k + i] = sub_mod(v[k], x, q);
      v[k] = add_mod(v[k], x, q);
    }

    for (j = 1; j < i; j++) {
      y = w[j * l];
      for (k = j; k < n; k += i + i) {
        //	x = ntt32_muln(v[k + i], y, q);
        x = (v[k + i] * y) % q;
        v[k + i] = sub_mod(v[k], x, q);
        v[k] = add_mod(v[k], x, q);
      }
    }

    l >>= 1;
  }
}

// Elementwise vector product  v = t (*) u.
// BD: modified to use 32 bit arithmetic
void ntt32_xmu(int32_t v[], uint32_t n, int32_t q, const int32_t t[], const int32_t u[]) {
  uint32_t i;


  // multiply each element point-by-point
  for (i = 0; i < n; i++) {
    //    v[i] = ntt32_muln(t[i], u[i], q);
    v[i] = (t[i] * u[i]) % q;
    if (v[i] < 0) v[i] += q;
  }

  assert(check_arg(v, n, q));

}

// Multiply with a scalar  v = t * c.
// BD: modified to use 32bit arithmetic
void ntt32_cmu(int32_t v[], uint32_t n, int32_t q, const int32_t t[], int32_t c) {
  uint32_t i;
  //  int32_t x;

  for (i = 0; i < n; i++) {
    // x = ntt32_muln(t[i], c, q);
    v[i] = (t[i] * c) % q;
    if (v[i] < 0) v[i] += q;
  }

  assert(check_arg(v, n, q));

}

// Flip the order.
// BD: removed normalization modulo q, except for v[0] since we assume 0 <= v[i] < q.
void ntt32_flp(int32_t v[], uint32_t n, int32_t q) {
  uint32_t i, j;
  int32_t x;

  for (i = 1, j = n - 1; i < j; i++, j--) {
    x = v[i];
    v[i] = v[j];
    v[j] = x;
  }

  if (v[0] != 0) {
    v[0] = q - v[0];
  }
  
  assert(check_arg(v, n, q));
}


/*
 * BD: SPECIALIZED VARIANTS FOR n=1024
 */
static void shuffle1024_v1(int32_t v[]) {
  uint32_t i, j, k;
  int32_t x;

  // bit-inverse shuffle
  j = 512;
  for (i = 1; i < 1023; i++) {       // 00..0 and 11..1 remain same
    if (i < j) {
      x = v[i];
      v[i] = v[j];
      v[j] = x;
    }
    k = 1024;
    do {
      k >>= 1;
      j ^= k;
    } while ((j & k) == 0);
  }
}

/*
 * bitrev5[i] = bit-inverse of i interpreted as a 5bit number
 */
static const uint32_t bitrev5[32] = {
  0, 16, 8, 24, 4, 20, 12, 28,
  2, 18, 10, 26, 6, 22, 14, 30,
  1, 17, 9, 25, 5, 21, 13, 29,
  3, 19, 11, 27, 7, 23, 15, 31
};

static inline uint32_t bitrev10(uint32_t x) {
  return bitrev5[x >> 5] | (bitrev5[x & 31] << 5);
}

static void shuffle1024_v2(int32_t v[]) {
  uint32_t i, j;
  int32_t x;

  for (i=1; i<1023; i++) {
    j = bitrev10(i);
    if (i < j) {
      x = v[i];
      v[i] = v[j];
      v[j] = x;
    }
  }
}

/*
 * bitrev_table for n=1024
 */
static const uint16_t bitrev1024[1024] = {
        0,   512,   256,   768,   128,   640,   384,   896,
       64,   576,   320,   832,   192,   704,   448,   960,
       32,   544,   288,   800,   160,   672,   416,   928,
       96,   608,   352,   864,   224,   736,   480,   992,
       16,   528,   272,   784,   144,   656,   400,   912,
       80,   592,   336,   848,   208,   720,   464,   976,
       48,   560,   304,   816,   176,   688,   432,   944,
      112,   624,   368,   880,   240,   752,   496,  1008,
        8,   520,   264,   776,   136,   648,   392,   904,
       72,   584,   328,   840,   200,   712,   456,   968,
       40,   552,   296,   808,   168,   680,   424,   936,
      104,   616,   360,   872,   232,   744,   488,  1000,
       24,   536,   280,   792,   152,   664,   408,   920,
       88,   600,   344,   856,   216,   728,   472,   984,
       56,   568,   312,   824,   184,   696,   440,   952,
      120,   632,   376,   888,   248,   760,   504,  1016,
        4,   516,   260,   772,   132,   644,   388,   900,
       68,   580,   324,   836,   196,   708,   452,   964,
       36,   548,   292,   804,   164,   676,   420,   932,
      100,   612,   356,   868,   228,   740,   484,   996,
       20,   532,   276,   788,   148,   660,   404,   916,
       84,   596,   340,   852,   212,   724,   468,   980,
       52,   564,   308,   820,   180,   692,   436,   948,
      116,   628,   372,   884,   244,   756,   500,  1012,
       12,   524,   268,   780,   140,   652,   396,   908,
       76,   588,   332,   844,   204,   716,   460,   972,
       44,   556,   300,   812,   172,   684,   428,   940,
      108,   620,   364,   876,   236,   748,   492,  1004,
       28,   540,   284,   796,   156,   668,   412,   924,
       92,   604,   348,   860,   220,   732,   476,   988,
       60,   572,   316,   828,   188,   700,   444,   956,
      124,   636,   380,   892,   252,   764,   508,  1020,
        2,   514,   258,   770,   130,   642,   386,   898,
       66,   578,   322,   834,   194,   706,   450,   962,
       34,   546,   290,   802,   162,   674,   418,   930,
       98,   610,   354,   866,   226,   738,   482,   994,
       18,   530,   274,   786,   146,   658,   402,   914,
       82,   594,   338,   850,   210,   722,   466,   978,
       50,   562,   306,   818,   178,   690,   434,   946,
      114,   626,   370,   882,   242,   754,   498,  1010,
       10,   522,   266,   778,   138,   650,   394,   906,
       74,   586,   330,   842,   202,   714,   458,   970,
       42,   554,   298,   810,   170,   682,   426,   938,
      106,   618,   362,   874,   234,   746,   490,  1002,
       26,   538,   282,   794,   154,   666,   410,   922,
       90,   602,   346,   858,   218,   730,   474,   986,
       58,   570,   314,   826,   186,   698,   442,   954,
      122,   634,   378,   890,   250,   762,   506,  1018,
        6,   518,   262,   774,   134,   646,   390,   902,
       70,   582,   326,   838,   198,   710,   454,   966,
       38,   550,   294,   806,   166,   678,   422,   934,
      102,   614,   358,   870,   230,   742,   486,   998,
       22,   534,   278,   790,   150,   662,   406,   918,
       86,   598,   342,   854,   214,   726,   470,   982,
       54,   566,   310,   822,   182,   694,   438,   950,
      118,   630,   374,   886,   246,   758,   502,  1014,
       14,   526,   270,   782,   142,   654,   398,   910,
       78,   590,   334,   846,   206,   718,   462,   974,
       46,   558,   302,   814,   174,   686,   430,   942,
      110,   622,   366,   878,   238,   750,   494,  1006,
       30,   542,   286,   798,   158,   670,   414,   926,
       94,   606,   350,   862,   222,   734,   478,   990,
       62,   574,   318,   830,   190,   702,   446,   958,
      126,   638,   382,   894,   254,   766,   510,  1022,
        1,   513,   257,   769,   129,   641,   385,   897,
       65,   577,   321,   833,   193,   705,   449,   961,
       33,   545,   289,   801,   161,   673,   417,   929,
       97,   609,   353,   865,   225,   737,   481,   993,
       17,   529,   273,   785,   145,   657,   401,   913,
       81,   593,   337,   849,   209,   721,   465,   977,
       49,   561,   305,   817,   177,   689,   433,   945,
      113,   625,   369,   881,   241,   753,   497,  1009,
        9,   521,   265,   777,   137,   649,   393,   905,
       73,   585,   329,   841,   201,   713,   457,   969,
       41,   553,   297,   809,   169,   681,   425,   937,
      105,   617,   361,   873,   233,   745,   489,  1001,
       25,   537,   281,   793,   153,   665,   409,   921,
       89,   601,   345,   857,   217,   729,   473,   985,
       57,   569,   313,   825,   185,   697,   441,   953,
      121,   633,   377,   889,   249,   761,   505,  1017,
        5,   517,   261,   773,   133,   645,   389,   901,
       69,   581,   325,   837,   197,   709,   453,   965,
       37,   549,   293,   805,   165,   677,   421,   933,
      101,   613,   357,   869,   229,   741,   485,   997,
       21,   533,   277,   789,   149,   661,   405,   917,
       85,   597,   341,   853,   213,   725,   469,   981,
       53,   565,   309,   821,   181,   693,   437,   949,
      117,   629,   373,   885,   245,   757,   501,  1013,
       13,   525,   269,   781,   141,   653,   397,   909,
       77,   589,   333,   845,   205,   717,   461,   973,
       45,   557,   301,   813,   173,   685,   429,   941,
      109,   621,   365,   877,   237,   749,   493,  1005,
       29,   541,   285,   797,   157,   669,   413,   925,
       93,   605,   349,   861,   221,   733,   477,   989,
       61,   573,   317,   829,   189,   701,   445,   957,
      125,   637,   381,   893,   253,   765,   509,  1021,
        3,   515,   259,   771,   131,   643,   387,   899,
       67,   579,   323,   835,   195,   707,   451,   963,
       35,   547,   291,   803,   163,   675,   419,   931,
       99,   611,   355,   867,   227,   739,   483,   995,
       19,   531,   275,   787,   147,   659,   403,   915,
       83,   595,   339,   851,   211,   723,   467,   979,
       51,   563,   307,   819,   179,   691,   435,   947,
      115,   627,   371,   883,   243,   755,   499,  1011,
       11,   523,   267,   779,   139,   651,   395,   907,
       75,   587,   331,   843,   203,   715,   459,   971,
       43,   555,   299,   811,   171,   683,   427,   939,
      107,   619,   363,   875,   235,   747,   491,  1003,
       27,   539,   283,   795,   155,   667,   411,   923,
       91,   603,   347,   859,   219,   731,   475,   987,
       59,   571,   315,   827,   187,   699,   443,   955,
      123,   635,   379,   891,   251,   763,   507,  1019,
        7,   519,   263,   775,   135,   647,   391,   903,
       71,   583,   327,   839,   199,   711,   455,   967,
       39,   551,   295,   807,   167,   679,   423,   935,
      103,   615,   359,   871,   231,   743,   487,   999,
       23,   535,   279,   791,   151,   663,   407,   919,
       87,   599,   343,   855,   215,   727,   471,   983,
       55,   567,   311,   823,   183,   695,   439,   951,
      119,   631,   375,   887,   247,   759,   503,  1015,
       15,   527,   271,   783,   143,   655,   399,   911,
       79,   591,   335,   847,   207,   719,   463,   975,
       47,   559,   303,   815,   175,   687,   431,   943,
      111,   623,   367,   879,   239,   751,   495,  1007,
       31,   543,   287,   799,   159,   671,   415,   927,
       95,   607,   351,   863,   223,   735,   479,   991,
       63,   575,   319,   831,   191,   703,   447,   959,
      127,   639,   383,   895,   255,   767,   511,  1023,
};

static void shuffle1024_v3(int32_t v[]) {
  uint32_t i, j;
  int32_t x;

  for (i=1; i<1023; i++) {
    j = bitrev1024[i];
    if (i < j) {
      x = v[i];
      v[i] = v[j];
      v[j] = x;
    }
  }
}


/*
 * List of pairs of indices to swap
 */
#define BITREV1024_NPAIRS 496

static const uint16_t bitrev1024_pair[BITREV1024_NPAIRS][2] = {
    {     1,   512 }, {     2,   256 }, {     3,   768 }, {     4,   128 },
    {     5,   640 }, {     6,   384 }, {     7,   896 }, {     8,    64 },
    {     9,   576 }, {    10,   320 }, {    11,   832 }, {    12,   192 },
    {    13,   704 }, {    14,   448 }, {    15,   960 }, {    16,    32 },
    {    17,   544 }, {    18,   288 }, {    19,   800 }, {    20,   160 },
    {    21,   672 }, {    22,   416 }, {    23,   928 }, {    24,    96 },
    {    25,   608 }, {    26,   352 }, {    27,   864 }, {    28,   224 },
    {    29,   736 }, {    30,   480 }, {    31,   992 }, {    33,   528 },
    {    34,   272 }, {    35,   784 }, {    36,   144 }, {    37,   656 },
    {    38,   400 }, {    39,   912 }, {    40,    80 }, {    41,   592 },
    {    42,   336 }, {    43,   848 }, {    44,   208 }, {    45,   720 },
    {    46,   464 }, {    47,   976 }, {    49,   560 }, {    50,   304 },
    {    51,   816 }, {    52,   176 }, {    53,   688 }, {    54,   432 },
    {    55,   944 }, {    56,   112 }, {    57,   624 }, {    58,   368 },
    {    59,   880 }, {    60,   240 }, {    61,   752 }, {    62,   496 },
    {    63,  1008 }, {    65,   520 }, {    66,   264 }, {    67,   776 },
    {    68,   136 }, {    69,   648 }, {    70,   392 }, {    71,   904 },
    {    73,   584 }, {    74,   328 }, {    75,   840 }, {    76,   200 },
    {    77,   712 }, {    78,   456 }, {    79,   968 }, {    81,   552 },
    {    82,   296 }, {    83,   808 }, {    84,   168 }, {    85,   680 },
    {    86,   424 }, {    87,   936 }, {    88,   104 }, {    89,   616 },
    {    90,   360 }, {    91,   872 }, {    92,   232 }, {    93,   744 },
    {    94,   488 }, {    95,  1000 }, {    97,   536 }, {    98,   280 },
    {    99,   792 }, {   100,   152 }, {   101,   664 }, {   102,   408 },
    {   103,   920 }, {   105,   600 }, {   106,   344 }, {   107,   856 },
    {   108,   216 }, {   109,   728 }, {   110,   472 }, {   111,   984 },
    {   113,   568 }, {   114,   312 }, {   115,   824 }, {   116,   184 },
    {   117,   696 }, {   118,   440 }, {   119,   952 }, {   121,   632 },
    {   122,   376 }, {   123,   888 }, {   124,   248 }, {   125,   760 },
    {   126,   504 }, {   127,  1016 }, {   129,   516 }, {   130,   260 },
    {   131,   772 }, {   133,   644 }, {   134,   388 }, {   135,   900 },
    {   137,   580 }, {   138,   324 }, {   139,   836 }, {   140,   196 },
    {   141,   708 }, {   142,   452 }, {   143,   964 }, {   145,   548 },
    {   146,   292 }, {   147,   804 }, {   148,   164 }, {   149,   676 },
    {   150,   420 }, {   151,   932 }, {   153,   612 }, {   154,   356 },
    {   155,   868 }, {   156,   228 }, {   157,   740 }, {   158,   484 },
    {   159,   996 }, {   161,   532 }, {   162,   276 }, {   163,   788 },
    {   165,   660 }, {   166,   404 }, {   167,   916 }, {   169,   596 },
    {   170,   340 }, {   171,   852 }, {   172,   212 }, {   173,   724 },
    {   174,   468 }, {   175,   980 }, {   177,   564 }, {   178,   308 },
    {   179,   820 }, {   181,   692 }, {   182,   436 }, {   183,   948 },
    {   185,   628 }, {   186,   372 }, {   187,   884 }, {   188,   244 },
    {   189,   756 }, {   190,   500 }, {   191,  1012 }, {   193,   524 },
    {   194,   268 }, {   195,   780 }, {   197,   652 }, {   198,   396 },
    {   199,   908 }, {   201,   588 }, {   202,   332 }, {   203,   844 },
    {   205,   716 }, {   206,   460 }, {   207,   972 }, {   209,   556 },
    {   210,   300 }, {   211,   812 }, {   213,   684 }, {   214,   428 },
    {   215,   940 }, {   217,   620 }, {   218,   364 }, {   219,   876 },
    {   220,   236 }, {   221,   748 }, {   222,   492 }, {   223,  1004 },
    {   225,   540 }, {   226,   284 }, {   227,   796 }, {   229,   668 },
    {   230,   412 }, {   231,   924 }, {   233,   604 }, {   234,   348 },
    {   235,   860 }, {   237,   732 }, {   238,   476 }, {   239,   988 },
    {   241,   572 }, {   242,   316 }, {   243,   828 }, {   245,   700 },
    {   246,   444 }, {   247,   956 }, {   249,   636 }, {   250,   380 },
    {   251,   892 }, {   253,   764 }, {   254,   508 }, {   255,  1020 },
    {   257,   514 }, {   259,   770 }, {   261,   642 }, {   262,   386 },
    {   263,   898 }, {   265,   578 }, {   266,   322 }, {   267,   834 },
    {   269,   706 }, {   270,   450 }, {   271,   962 }, {   273,   546 },
    {   274,   290 }, {   275,   802 }, {   277,   674 }, {   278,   418 },
    {   279,   930 }, {   281,   610 }, {   282,   354 }, {   283,   866 },
    {   285,   738 }, {   286,   482 }, {   287,   994 }, {   289,   530 },
    {   291,   786 }, {   293,   658 }, {   294,   402 }, {   295,   914 },
    {   297,   594 }, {   298,   338 }, {   299,   850 }, {   301,   722 },
    {   302,   466 }, {   303,   978 }, {   305,   562 }, {   307,   818 },
    {   309,   690 }, {   310,   434 }, {   311,   946 }, {   313,   626 },
    {   314,   370 }, {   315,   882 }, {   317,   754 }, {   318,   498 },
    {   319,  1010 }, {   321,   522 }, {   323,   778 }, {   325,   650 },
    {   326,   394 }, {   327,   906 }, {   329,   586 }, {   331,   842 },
    {   333,   714 }, {   334,   458 }, {   335,   970 }, {   337,   554 },
    {   339,   810 }, {   341,   682 }, {   342,   426 }, {   343,   938 },
    {   345,   618 }, {   346,   362 }, {   347,   874 }, {   349,   746 },
    {   350,   490 }, {   351,  1002 }, {   353,   538 }, {   355,   794 },
    {   357,   666 }, {   358,   410 }, {   359,   922 }, {   361,   602 },
    {   363,   858 }, {   365,   730 }, {   366,   474 }, {   367,   986 },
    {   369,   570 }, {   371,   826 }, {   373,   698 }, {   374,   442 },
    {   375,   954 }, {   377,   634 }, {   379,   890 }, {   381,   762 },
    {   382,   506 }, {   383,  1018 }, {   385,   518 }, {   387,   774 },
    {   389,   646 }, {   391,   902 }, {   393,   582 }, {   395,   838 },
    {   397,   710 }, {   398,   454 }, {   399,   966 }, {   401,   550 },
    {   403,   806 }, {   405,   678 }, {   406,   422 }, {   407,   934 },
    {   409,   614 }, {   411,   870 }, {   413,   742 }, {   414,   486 },
    {   415,   998 }, {   417,   534 }, {   419,   790 }, {   421,   662 },
    {   423,   918 }, {   425,   598 }, {   427,   854 }, {   429,   726 },
    {   430,   470 }, {   431,   982 }, {   433,   566 }, {   435,   822 },
    {   437,   694 }, {   439,   950 }, {   441,   630 }, {   443,   886 },
    {   445,   758 }, {   446,   502 }, {   447,  1014 }, {   449,   526 },
    {   451,   782 }, {   453,   654 }, {   455,   910 }, {   457,   590 },
    {   459,   846 }, {   461,   718 }, {   463,   974 }, {   465,   558 },
    {   467,   814 }, {   469,   686 }, {   471,   942 }, {   473,   622 },
    {   475,   878 }, {   477,   750 }, {   478,   494 }, {   479,  1006 },
    {   481,   542 }, {   483,   798 }, {   485,   670 }, {   487,   926 },
    {   489,   606 }, {   491,   862 }, {   493,   734 }, {   495,   990 },
    {   497,   574 }, {   499,   830 }, {   501,   702 }, {   503,   958 },
    {   505,   638 }, {   507,   894 }, {   509,   766 }, {   511,  1022 },
    {   515,   769 }, {   517,   641 }, {   519,   897 }, {   521,   577 },
    {   523,   833 }, {   525,   705 }, {   527,   961 }, {   529,   545 },
    {   531,   801 }, {   533,   673 }, {   535,   929 }, {   537,   609 },
    {   539,   865 }, {   541,   737 }, {   543,   993 }, {   547,   785 },
    {   549,   657 }, {   551,   913 }, {   553,   593 }, {   555,   849 },
    {   557,   721 }, {   559,   977 }, {   563,   817 }, {   565,   689 },
    {   567,   945 }, {   569,   625 }, {   571,   881 }, {   573,   753 },
    {   575,  1009 }, {   579,   777 }, {   581,   649 }, {   583,   905 },
    {   587,   841 }, {   589,   713 }, {   591,   969 }, {   595,   809 },
    {   597,   681 }, {   599,   937 }, {   601,   617 }, {   603,   873 },
    {   605,   745 }, {   607,  1001 }, {   611,   793 }, {   613,   665 },
    {   615,   921 }, {   619,   857 }, {   621,   729 }, {   623,   985 },
    {   627,   825 }, {   629,   697 }, {   631,   953 }, {   635,   889 },
    {   637,   761 }, {   639,  1017 }, {   643,   773 }, {   647,   901 },
    {   651,   837 }, {   653,   709 }, {   655,   965 }, {   659,   805 },
    {   661,   677 }, {   663,   933 }, {   667,   869 }, {   669,   741 },
    {   671,   997 }, {   675,   789 }, {   679,   917 }, {   683,   853 },
    {   685,   725 }, {   687,   981 }, {   691,   821 }, {   695,   949 },
    {   699,   885 }, {   701,   757 }, {   703,  1013 }, {   707,   781 },
    {   711,   909 }, {   715,   845 }, {   719,   973 }, {   723,   813 },
    {   727,   941 }, {   731,   877 }, {   733,   749 }, {   735,  1005 },
    {   739,   797 }, {   743,   925 }, {   747,   861 }, {   751,   989 },
    {   755,   829 }, {   759,   957 }, {   763,   893 }, {   767,  1021 },
    {   775,   899 }, {   779,   835 }, {   783,   963 }, {   787,   803 },
    {   791,   931 }, {   795,   867 }, {   799,   995 }, {   807,   915 },
    {   811,   851 }, {   815,   979 }, {   823,   947 }, {   827,   883 },
    {   831,  1011 }, {   839,   907 }, {   847,   971 }, {   855,   939 },
    {   859,   875 }, {   863,  1003 }, {   871,   923 }, {   879,   987 },
    {   887,   955 }, {   895,  1019 }, {   911,   967 }, {   919,   935 },
    {   927,   999 }, {   943,   983 }, {   959,  1015 }, {   991,  1007 },
};

static void shuffle1024_v4(int32_t v[]) {
  uint32_t i, j, k;
  int32_t x;

  for (i=0; i<BITREV1024_NPAIRS; i++) {
    j = bitrev1024_pair[i][0];
    k = bitrev1024_pair[i][1];
    x = v[j];
    v[j] = v[k];
    v[k] = x;
  }
}

/*
 * FFT (after bit-reverse shuffling)
 */
static void ntt32_fft1024_core(int32_t v[], int32_t q, const int32_t w[]) {
  uint32_t i, j, k, l, m;
  int32_t x, y;

  for (i = 1, l = 1024; i < 1024; i <<= 1, l >>= 1) {
    // invariant: i * l = 1024
    for (k = 0; k < 1024; k += i + i) {
      x = v[k + i];
      v[k + i] = sub_mod(v[k], x, q);
      v[k] = add_mod(v[k], x, q);
    }

    for (j = 1, m = l; j < i; j++, m += l) {
      // m = j * l
      y = w[m];
      for (k = j; k < 1024; k += i + i) {
        x = (v [k + i] * y) % q;
        v[k + i] = sub_mod(v[k], x, q);
        v[k] = add_mod(v[k], x, q);
      }
    }
  }
}

void ntt32_fft1024_var1(int32_t v[], int32_t q, const int32_t w[]) {
  shuffle1024_v1(v);
  ntt32_fft1024_core(v, q, w);
}

void ntt32_fft1024_var2(int32_t v[], int32_t q, const int32_t w[]) {
  shuffle1024_v2(v);
  ntt32_fft1024_core(v, q, w);
}

void ntt32_fft1024_var3(int32_t v[], int32_t q, const int32_t w[]) {
  shuffle1024_v3(v);
  ntt32_fft1024_core(v, q, w);
}

void ntt32_fft1024_var4(int32_t v[], int32_t q, const int32_t w[]) {
  shuffle1024_v4(v);
  ntt32_fft1024_core(v, q, w);
}
